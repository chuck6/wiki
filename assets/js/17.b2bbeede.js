(window.webpackJsonp=window.webpackJsonp||[]).push([[17],{773:function(s,a,e){"use strict";e.r(a);var t=e(20),r=Object(t.a)({},(function(){var s=this,a=s.$createElement,e=s._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"registry镜像管理"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#registry镜像管理"}},[s._v("#")]),s._v(" Registry镜像管理")]),s._v(" "),e("h2",{attrs:{id:"安装docker环境"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#安装docker环境"}},[s._v("#")]),s._v(" 安装docker环境")]),s._v(" "),e("p",[s._v("请参照其他文档")]),s._v(" "),e("h2",{attrs:{id:"下载registry镜像"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#下载registry镜像"}},[s._v("#")]),s._v(" 下载registry镜像")]),s._v(" "),e("p",[e("code",[s._v("$docker pull registry:2.7.1")])]),s._v(" "),e("h2",{attrs:{id:"启动容器"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#启动容器"}},[s._v("#")]),s._v(" 启动容器")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('$ docker run –d –p 5000:5000  -v /app/docker/registry_data:/var/lib/registry –restart=always \n--name registry  -e "REGISTRY_STORAGE_DELETE_ENABLED=true" registry:2.7.1\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("其中REGISTRY_STORAGE_DELETE_ENABLED这个环境变量是用于打开可以删除镜像的开关。\n也可以在容器内设置/etc/docker/registry/config.yml文件，加入storage.delete.enabled设置为true。修改完容器后，重启容器。参考如下配置：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("version: 0.1\nlog:\n  fields:\n    service: registry\nstorage:\n  cache:\n    blobdescriptor: inmemorys\n  filesystem:\n    rootdirectory: /var/lib/registry\n  delete:\n    enable: true\nhttp:        \n  addr: :5000                        \n  headers:                           \n    X-Content-Type-Options: [nosniff]\nhealth:          \n  storagedriver: \n    enabled: true\n    interval: 10s\n    threshold: 3\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br")])]),e("h2",{attrs:{id:"修改docker环境变量"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#修改docker环境变量"}},[s._v("#")]),s._v(" 修改docker环境变量")]),s._v(" "),e("p",[s._v("添加docker环境insecure-registries参数，参考下面修改")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('#vi /etc/docker/daemon.json\n{\n  "insecure-registries": [“192.168.3.58:5000”]\n}\n#systemctl daemon-reload\n#systemctl restart docker\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("h2",{attrs:{id:"registry常见操作命令"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#registry常见操作命令"}},[s._v("#")]),s._v(" Registry常见操作命令")]),s._v(" "),e("h3",{attrs:{id:"上传镜像"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#上传镜像"}},[s._v("#")]),s._v(" 上传镜像")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("$docker tag xxxx:yyyy  192.168.3.60:5000/xxxx:yyyy\n$docker push 192.168.3.60:5000/xxxx:yyyy\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("h3",{attrs:{id:"下载镜像"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#下载镜像"}},[s._v("#")]),s._v(" 下载镜像")]),s._v(" "),e("p",[e("code",[s._v("$docker pull 192.168.3.60:5000/xxxx:yyyy")])]),s._v(" "),e("h3",{attrs:{id:"列出所有的镜像仓库"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#列出所有的镜像仓库"}},[s._v("#")]),s._v(" 列出所有的镜像仓库")]),s._v(" "),e("p",[s._v("其中IP和端口替换为指定的源")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("$curl -XGET http://10.128.91.224:5000/v2/_catalog\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h3",{attrs:{id:"列出指定镜像的所有标签"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#列出指定镜像的所有标签"}},[s._v("#")]),s._v(" 列出指定镜像的所有标签")]),s._v(" "),e("p",[s._v("查看在该仓库下面mysql的所有tags表前列")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("$curl -XGET http://10.128.91.224:5000/v2/mysql/tags/list\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h3",{attrs:{id:"查看指定镜像-指定tag的digest"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#查看指定镜像-指定tag的digest"}},[s._v("#")]),s._v(" 查看指定镜像/指定tag的digest")]),s._v(" "),e("p",[s._v("查看该仓库下面mysql 的tag是5.7.25的digest号")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('$curl  --header "Accept: application/vnd.docker.distribution.manifest.v2+json" -I -X GET http://10.128.91.224:5000/v2/mysql/manifests/5.7.25\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h3",{attrs:{id:"删除指定的tag"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#删除指定的tag"}},[s._v("#")]),s._v(" 删除指定的tag")]),s._v(" "),e("p",[s._v("其中sha256后面的就是上面查找出来的digest号")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("$curl -I -X DELETE http://10.128.91.224:5000/v2/mysql/manifests/sha256:fcaff905397ba63fd376d0c3019f1f1cb6e7506131389edbcb3d22719f1ae54d\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h3",{attrs:{id:"删除镜像项目名称"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#删除镜像项目名称"}},[s._v("#")]),s._v(" 删除镜像项目名称")]),s._v(" "),e("p",[s._v("如果某个镜像名称下面的所有tag都已经删除了，而且需要删除这个镜像的目录，那么就可以考虑删除掉这个目录，避免在查询的时候还能看到这个镜像名称，而tag确实null了。")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("$cd /app/registry_data/docker/registry/v2/repositories\n目录是具体的是创建registry时映射的路径\n然后删除这个路径下面的对应的项目名称。\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("h3",{attrs:{id:"垃圾回收"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#垃圾回收"}},[s._v("#")]),s._v(" 垃圾回收")]),s._v(" "),e("p",[s._v("其中registry是创建的容器的名称，实际上是在容器内执行垃圾回收操作。")]),s._v(" "),e("p",[e("code",[s._v("$docker exec -it registry /bin/registry garbage-collect /etc/docker/registry/config.yml")])])])}),[],!1,null,null,null);a.default=r.exports}}]);